<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Protected API Demo (Supabase + CF Pages)</title>
    <style>
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          "Helvetica Neue", Arial;
        margin: 24px;
      }
      .card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        max-width: 720px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      button {
        padding: 8px 14px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        cursor: pointer;
      }
      code,
      pre {
        background: #f8fafc;
        border-radius: 8px;
        padding: 2px 6px;
      }
      .muted {
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    <h1>受保护接口演示</h1>
    <p class="muted">
      页面会先检查是否已登录。未登录将跳转到登录页；已登录可点击按钮调用
      /api/secure/*。
    </p>

    <div class="card">
      <h3>当前会话</h3>
      <div id="sessionBox" class="muted">正在检测登录状态…</div>
      <div class="row" style="margin-top: 12px">
        <button id="btnCall">调用受保护 API</button>
        <button id="btnLogout">退出登录并回到登录页</button>
      </div>
    </div>

    <div class="card" style="margin-top: 16px">
      <h3>API 响应</h3>
      <pre id="out" style="white-space: pre-wrap">(暂无)</pre>
    </div>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      // === 必改：你的配置 ===
      const SUPABASE_URL = "https://stmrfgqqwduhqikmnkuz.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0bXJmZ3Fxd2R1aHFpa21ua3V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxOTQxOTcsImV4cCI6MjA2OTc3MDE5N30.66zZyOx8_KbZvO5nSfjCBmQuQ_Quf5VluaIZfbbSM4A";
      const API_URL = "https://learning01.riplon.net/api/secure/rt_d1_getdata"; // 受保护API
      const LOGIN_PAGE_URL =
        "https://learning01.riplon.net/learning/supabase/login.html"; // 你的登录页
      // =====================

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const sessionBox = document.getElementById("sessionBox");
      const out = document.getElementById("out");
      const btnCall = document.getElementById("btnCall");
      const btnLogout = document.getElementById("btnLogout");

      // 跳转到登录页，带上 next=当前地址
      function redirectToLogin() {
        const here = window.location.href;
        const url = new URL(LOGIN_PAGE_URL);
        url.searchParams.set("next", here);
        window.location.replace(url.toString());
      }

      // 渲染会话信息
      function renderSession(session) {
        if (!session) {
          sessionBox.textContent = "未登录";
          return;
        }
        const user = session.user;
        const exp = session.expires_at
          ? new Date(session.expires_at * 1000)
          : null;
        sessionBox.innerHTML = `
        <div>用户ID：<code>${user?.id || "-"}</code></div>
        <div>邮箱：<code>${user?.email || "-"}</code></div>
        <div>过期时间：<code>${exp ? exp.toLocaleString() : "-"}</code></div>
      `;
      }

      async function ensureLoggedInOrRedirect() {
        const {
          data: { session },
          error,
        } = await supabase.auth.getSession();
        if (error || !session) {
          redirectToLogin();
          return null;
        }
        renderSession(session);
        return session;
      }

      // 监听 token 自动轮换（保持 UI 同步）
      supabase.auth.onAuthStateChange((_event, session) => {
        renderSession(session);
        if (!session) redirectToLogin();
      });

      // 调用受保护 API
      async function callProtected() {
        out.textContent = "(请求中…)";
        const {
          data: { session },
        } = await supabase.auth.getSession();
        if (!session?.access_token) {
          out.textContent = "没有 access_token，请先登录。";
          redirectToLogin();
          return;
        }
        const res = await fetch(API_URL, {
          method: "GET",
          headers: { Authorization: `Bearer ${session.access_token}` },
        });

        // 若 401，可能 token 过期/无效，触发一次重查并跳转登录
        if (res.status === 401) {
          out.textContent = "401 未授权，将检查登录并可能跳转到登录页…";
          const s = await ensureLoggedInOrRedirect();
          if (!s) return; // 已跳转
        }

        // 优先尝试 JSON
        const text = await res.text();
        try {
          out.textContent = JSON.stringify(JSON.parse(text), null, 2);
        } catch {
          out.textContent = text;
        }
      }

      // 退出并回到登录页
      async function logoutAndBack() {
        await supabase.auth.signOut();
        redirectToLogin();
      }

      btnCall.addEventListener("click", callProtected);
      btnLogout.addEventListener("click", logoutAndBack);

      // 入口：先确保登录，否则重定向
      await ensureLoggedInOrRedirect();
    </script>
  </body>
</html>
